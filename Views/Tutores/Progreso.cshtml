@model ctrlcctrlv.Models.ViewModels.ProgresoViewModel
@{
    ViewBag.Title = "Progreso Académico";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <h2>Progreso de @Model.AlumnoNombre</h2>
    <p class="text-muted">Evolución académica del alumno por materia.</p>

    <!-- Gráfico -->
    <div class="row mb-4 mt-3">
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm p-3">
                <canvas id="chartRendimiento" width="800" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Tabla de progreso -->
    <div class="row mt-4">
        <div class="col-12 col-lg-10">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Materia</th>
                        <th>Última nota</th>
                        <th>Promedio</th>
                        <th>Observación</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in Model.Materias)
                    {
                        <tr>
                            <td>@m.NombreMateria</td>
                            <td>@m.UltimaNota</td>
                            <td>@m.Promedio.ToString("0.0")</td>
                            <td>@m.Observacion</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                            ViewBag.ChartLabels ?? new string[] { "1°", "2°", "3°" }
                    )
            );

        const datasetsServer = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                        ViewBag.ChartDatasets ?? new object[] { }
                )
        );

        const datasets = Array.isArray(datasetsServer) ? datasetsServer : [];

            const formatted = datasets.map(ds => ({
                label: ds.label,
                data: ds.data,
                fill: false,
                tension: 0.25,
                borderWidth: 3
            }));

            const ctx = document.getElementById('chartRendimiento').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: formatted
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: true,
                            text: 'Evolución de notas por trimestre'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 10
                        }
                    }
                }
            });
        })();
    </script>
}
